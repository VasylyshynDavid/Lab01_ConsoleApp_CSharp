using System;
using System.Collections.Generic;
using System.IO; // Необхідно для роботи з файлами (StreamWriter, BinaryWriter)
using System.Text; // Необхідно для кодування UTF-8

/// <summary>
/// Клас, що описує об'єкт "Літак".
/// (Код з вашої Лабораторної роботи №10)
/// </summary>
public class Airplane
{
    public string Model { get; set; }
    public string Airline { get; set; }
    public int PassengerCapacity { get; set; }
    public double MaxSpeed { get; set; }
    public int EngineCount { get; set; }
    public int YearOfManufacture { get; set; }
    public bool IsInternational { get; set; }

    public double PassengersPerEngine
    {
        get
        {
            if (EngineCount == 0) return 0;
            return (double)PassengerCapacity / EngineCount;
        }
    }
    
    // Конструктор за замовчуванням
    public Airplane()
    {
        Model = "N/A";
        Airline = "N/A";
    }

    /// <summary>
    /// Конструктор для читання з текстового файлу
    /// </summary>
    public Airplane(string model, string airline, int capacity, double speed, int engines, int year, bool isIntl)
    {
        Model = model;
        Airline = airline;
        PassengerCapacity = capacity;
        MaxSpeed = speed;
        EngineCount = engines;
        YearOfManufacture = year;
        IsInternational = isIntl;
    }
}

/// <summary>
/// Головний клас програми, що імітує CRUD-додаток
/// (Доповнено функціоналом Лабораторної роботи №13)
/// </summary>
public class Program
{
    // Наша "база даних" - список літаків
    static List<Airplane> airplaneDatabase = new List<Airplane>();

    // Імена файлів для збереження (для простоти)
    const string textFileName = "airplanes.txt";
    const string binaryFileName = "airplanes.dat"; // .dat або .towns, як у зразку

    public static void Main()
    {
        // Встановлюємо кодування для коректної роботи кирилиці
        Console.OutputEncoding = Encoding.UTF8;
        Console.InputEncoding = Encoding.UTF8;

        while (true)
        {
            DisplayAirplanes(); // Завжди показуємо таблицю
            
            // --- ОНОВЛЕНЕ МЕНЮ ---
            Console.WriteLine("--- Панель інструментів (Лабораторна 13) ---");
            Console.WriteLine("1. Додати літак");
            Console.WriteLine("2. Редагувати літак");
            Console.WriteLine("3. Видалити літак");
            Console.WriteLine("4. Очистити таблицю");
            Console.WriteLine("--- Файлові операції ---");
            Console.WriteLine($"5. Зберегти у текстовий файл ({textFileName})");
            Console.WriteLine($"6. Зберегти у бінарний файл ({binaryFileName})");
            Console.WriteLine($"7. Завантажити з текстового файлу ({textFileName})");
            Console.WriteLine($"8. Завантажити з бінарного файлу ({binaryFileName})");
            Console.WriteLine("9. Вихід");
            Console.Write("Ваш вибір: ");

            string choice = Console.ReadLine();

            switch (choice)
            {
                case "1":
                    AddAirplane();
                    break;
                case "2":
                    EditAirplane();
                    break;
                case "3":
                    DeleteAirplane();
                    break;
                case "4":
                    ClearAirplanes();
                    break;
                // --- НОВІ ОПЦІЇ (ЛАБ 13) ---
                case "5":
                    SaveAsText();
                    break;
                case "6":
                    SaveAsBinary();
                    break;
                case "7":
                    OpenFromText();
                    break;
                case "8":
                    OpenFromBinary();
                    break;
                case "9":
                    return; // Вихід з програми
                default:
                    Console.WriteLine("Невірний вибір. Натисніть Enter...");
                    Console.ReadLine();
                    break;
            }
        }
    }

    // --- МЕТОДИ ЗБЕРЕЖЕННЯ ТА ЗАВАНТАЖЕННЯ (НОВЕ В ЛАБ 13) ---

    /// <summary>
    /// (ЛР 13) Зберігає базу даних у текстовий файл
    /// </summary>
    static void SaveAsText()
    {
        Console.WriteLine($"\nЗбереження у {textFileName}...");
        try
        {
            // Використовуємо StreamWriter для запису тексту [cite: 80]
            // 'false' означає перезапис файлу, 'Encoding.UTF8' - для кирилиці
            using (StreamWriter sw = new StreamWriter(textFileName, false, Encoding.UTF8))
            {
                foreach (Airplane plane in airplaneDatabase)
                {
                    // Створюємо рядок, розділений табуляцією (\t), як у зразку [cite: 80]
                    string line = string.Join("\t",
                        plane.Model,
                        plane.Airline,
                        plane.PassengerCapacity,
                        plane.MaxSpeed,
                        plane.EngineCount,
                        plane.YearOfManufacture,
                        plane.IsInternational
                    );
                    sw.WriteLine(line);
                }
            }
            Console.WriteLine("Успішно збережено. Натисніть Enter...");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Сталася помилка при збереженні: {ex.Message}");
        }
        Console.ReadLine();
    }

    /// <summary>
    /// (ЛР 13) Зберігає базу даних у бінарний файл
    /// </summary>
    static void SaveAsBinary()
    {
        Console.WriteLine($"\nЗбереження у {binaryFileName}...");
        try
        {
            // Використовуємо BinaryWriter для запису "сирих" даних [cite: 81]
            using (BinaryWriter bw = new BinaryWriter(File.Open(binaryFileName, FileMode.Create)))
            {
                foreach (Airplane plane in airplaneDatabase)
                {
                    // Записуємо кожну властивість послідовно
                    bw.Write(plane.Model);
                    bw.Write(plane.Airline);
                    bw.Write(plane.PassengerCapacity);
                    bw.Write(plane.MaxSpeed);
                    bw.Write(plane.EngineCount);
                    bw.Write(plane.YearOfManufacture);
                    bw.Write(plane.IsInternational);
                }
            }
            Console.WriteLine("Успішно збережено. Натисніть Enter...");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Сталася помилка при збереженні: {ex.Message}");
        }
        Console.ReadLine();
    }

    /// <summary>
    /// (ЛР 13) Завантажує базу даних з текстового файлу
    /// </summary>
    static void OpenFromText()
    {
        Console.WriteLine($"\nЗавантаження з {textFileName}...");
        if (!File.Exists(textFileName))
        {
            Console.WriteLine("Файл не знайдено. Натисніть Enter...");
            Console.ReadLine();
            return;
        }

        try
        {
            // Використовуємо StreamReader для читання тексту [cite: 82]
            using (StreamReader sr = new StreamReader(textFileName, Encoding.UTF8))
            {
                airplaneDatabase.Clear(); // Очищуємо поточну базу
                string line;
                while ((line = sr.ReadLine()) != null) // Читаємо до кінця файлу
                {
                    string[] parts = line.Split('\t'); // Розділяємо рядок по табуляції [cite: 82]
                    
                    // Перевіряємо, чи коректна кількість полів
                    if (parts.Length == 7)
                    {
                        Airplane plane = new Airplane(
                            parts[0],
                            parts[1],
                            int.Parse(parts[2]),
                            double.Parse(parts[3]),
                            int.Parse(parts[4]),
                            int.Parse(parts[5]),
                            bool.Parse(parts[6])
                        );
                        airplaneDatabase.Add(plane);
                    }
                }
            }
            Console.WriteLine("Дані успішно завантажено. Натисніть Enter...");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Сталася помилка при завантаженні: {ex.Message}");
        }
        Console.ReadLine();
    }

    /// <summary>
    /// (ЛР 13) Завантажує базу даних з бінарного файлу
    /// </summary>
    static void OpenFromBinary()
    {
        Console.WriteLine($"\nЗавантаження з {binaryFileName}...");
        if (!File.Exists(binaryFileName))
        {
            Console.WriteLine("Файл не знайдено. Натисніть Enter...");
            Console.ReadLine();
            return;
        }

        try
        {
            // Використовуємо BinaryReader для читання "сирих" даних [cite: 82-83]
            using (BinaryReader br = new BinaryReader(File.Open(binaryFileName, FileMode.Open)))
            {
                airplaneDatabase.Clear(); // Очищуємо поточну базу

                // Читаємо, поки не досягнемо кінця файлу
                while (br.BaseStream.Position < br.BaseStream.Length)
                {
                    // ВАЖЛИВО: Читаємо у тому ж порядку, в якому записували
                    string model = br.ReadString();
                    string airline = br.ReadString();
                    int capacity = br.ReadInt32();
                    double speed = br.ReadDouble();
                    int engines = br.ReadInt32();
                    int year = br.ReadInt32();
                    bool isIntl = br.ReadBoolean();

                    Airplane plane = new Airplane(model, airline, capacity, speed, engines, year, isIntl);
                    airplaneDatabase.Add(plane);
                }
            }
            Console.WriteLine("Дані успішно завантажено. Натисніть Enter...");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Сталася помилка при завантаженні: {ex.Message}");
        }
        Console.ReadLine();
    }


    // --- МЕТОДИ CRUD (З ЛАБОРАТОРНОЇ 10) ---

    /// <summary>
    /// (ЛР 10) Відображує список літаків у вигляді таблиці
    /// </summary>
    static void DisplayAirplanes()
    {
        Console.Clear();
        Console.WriteLine("--- Таблиця літаків (DataGridView) ---");
        
        if (airplaneDatabase.Count == 0)
        {
            Console.WriteLine("[Таблиця порожня]");
        }
        else
        {
            // Форматований заголовок
            string header = String.Format("{0,-3} | {1,-20} | {2,-15} | {3,-5} | {4,-8} | {5,-4} | {6,-5} | {7,-8}",
                "№", "Модель", "Авіалінія", "Пас.", "Швидкість", "Рік", "Міжн.", "Пас/Двиг");
            Console.WriteLine(header);
            Console.WriteLine(new string('-', 85));

            // Виведення кожного літака
            for (int i = 0; i < airplaneDatabase.Count; i++)
            {
                Airplane plane = airplaneDatabase[i];
                string line = String.Format("{0,-3} | {1,-20} | {2,-15} | {3,-5} | {4,-8:F0} | {5,-4} | {6,-5} | {7,-8:F2}",
                    (i + 1),
                    plane.Model,
                    plane.Airline,
                    plane.PassengerCapacity,
                    plane.MaxSpeed,
                    plane.YearOfManufacture,
                    plane.IsInternational ? "Так" : "Ні",
                    plane.PassengersPerEngine
                );
                Console.WriteLine(line);
            }
        }
        Console.WriteLine(new string('-', 85) + "\n");
    }

    /// <summary>
    /// (ЛР 10) Додає новий літак
    /// </summary>
    static void AddAirplane()
    {
        Airplane newPlane = new Airplane(); // Створюємо об'єкт з N/A
        bool success = ShowAirplaneDialog(newPlane, "Додавання нового літака");

        if (success)
        {
            airplaneDatabase.Add(newPlane);
            Console.WriteLine("\nЛітак успішно додано. Натисніть Enter...");
        }
        else
        {
            Console.WriteLine("\nДодавання скасовано. Натисніть Enter...");
        }
        Console.ReadLine();
    }

    /// <summary>
    /// (ЛР 10) Редагує існуючий літак
    /// </summary>
    static void EditAirplane()
    {
        if (airplaneDatabase.Count == 0)
        {
            Console.WriteLine("Немає чого редагувати. Натисніть Enter...");
            Console.ReadLine();
            return;
        }

        Console.Write("Введіть номер літака для редагування (1, 2...): ");
        if (!int.TryParse(Console.ReadLine(), out int index) || index < 1 || index > airplaneDatabase.Count)
        {
            Console.WriteLine("Невірний номер. Натисніть Enter...");
            Console.ReadLine();
            return;
        }

        Airplane planeToEdit = airplaneDatabase[index - 1];
        bool success = ShowAirplaneDialog(planeToEdit, $"Редагування: {planeToEdit.Model}");

        if (success)
        {
            Console.WriteLine("\nЛітак успішно оновлено. Натисніть Enter...");
        }
        else
        {
            Console.WriteLine("\nРедагування скасовано. Натисніть Enter...");
        }
        Console.ReadLine();
    }

    /// <summary>
    /// (ЛР 10) Видаляє літак
    /// </summary>
    static void DeleteAirplane()
    {
        if (airplaneDatabase.Count == 0)
        {
            Console.WriteLine("Немає чого видаляти. Натисніть Enter...");
            Console.ReadLine();
            return;
        }
        
        Console.Write("Введіть номер літака для видалення (1, 2...): ");
        if (!int.TryParse(Console.ReadLine(), out int index) || index < 1 || index > airplaneDatabase.Count)
        {
            Console.WriteLine("Невірний номер. Натисніть Enter...");
            Console.ReadLine();
            return;
        }

        Airplane planeToDelete = airplaneDatabase[index - 1];
        Console.Write($"Ви впевнені, що хочете видалити {planeToDelete.Model}? (y/n): ");
        if (Console.ReadLine().ToLower() == "y")
        {
            airplaneDatabase.RemoveAt(index - 1);
            Console.WriteLine("Літак видалено. Натисніть Enter...");
        }
        else
        {
            Console.WriteLine("Видалення скасовано. Натисніть Enter...");
        }
        Console.ReadLine();
    }

    /// <summary>
    /// (ЛР 10) Очищує всю базу
    /// </summary>
    static void ClearAirplanes()
    {
        Console.Write("Ви впевнені, що хочете очистити всю таблицю? (y/n): ");
        if (Console.ReadLine().ToLower() == "y")
        {
            airplaneDatabase.Clear();
            Console.WriteLine("Таблицю очищено. Натисніть Enter...");
        }
        else
        {
            Console.WriteLine("Очищення скасовано. Натисніть Enter...");
        }
        Console.ReadLine();
    }

    /// <summary>
    /// (ЛР 10) Діалог введення/редагування
    /// </summary>
    static bool ShowAirplaneDialog(Airplane plane, string title)
    {
        try
        {
            Console.WriteLine($"\n--- {title} ---");
            Console.WriteLine("(Натисніть Enter, щоб залишити поточне значення)");

            Console.Write($"Модель [{plane.Model}]: ");
            string modelInput = Console.ReadLine();
            if (!string.IsNullOrEmpty(modelInput)) plane.Model = modelInput;

            Console.Write($"Авіалінія [{plane.Airline}]: ");
            string airlineInput = Console.ReadLine();
            if (!string.IsNullOrEmpty(airlineInput)) plane.Airline = airlineInput;

            Console.Write($"Пасажиромісткість [{plane.PassengerCapacity}]: ");
            string capacityInput = Console.ReadLine();
            if (!string.IsNullOrEmpty(capacityInput)) plane.PassengerCapacity = int.Parse(capacityInput);

            Console.Write($"Макс. швидкість [{plane.MaxSpeed}]: ");
            string speedInput = Console.ReadLine();
            if (!string.IsNullOrEmpty(speedInput)) plane.MaxSpeed = double.Parse(speedInput);

            Console.Write($"Кількість двигунів [{plane.EngineCount}]: ");
            string engineInput = Console.ReadLine();
            if (!string.IsNullOrEmpty(engineInput)) plane.EngineCount = int.Parse(engineInput);

            Console.Write($"Рік випуску [{plane.YearOfManufacture}]: ");
            string yearInput = Console.ReadLine();
            if (!string.IsNullOrEmpty(yearInput)) plane.YearOfManufacture = int.Parse(yearInput);

            Console.Write($"Міжнародний (y/n) [{plane.IsInternational}]: ");
            string intlInput = Console.ReadLine().ToLower();
            if (intlInput == "y") plane.IsInternational = true;
            if (intlInput == "n") plane.IsInternational = false;

            Console.Write("\nЗберегти зміни? (y - Ok / n - Скасувати): ");
            return Console.ReadLine().ToLower() == "y";
        }
        catch (FormatException)
        {
            Console.WriteLine("Помилка формату! Введено не число.");
            return false;
        }
    }
}